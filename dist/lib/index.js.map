{"version":3,"file":"index.js","sources":["../../src/colorgram.ts","../../src/utils.ts"],"sourcesContent":["export type Data = number[] | any[] | Uint8Array;\n\n/**\n * RGB = 3, RGBAlpha = 4\n * TODO: Alpha not calculated\n * TODO: Grey not supported\n */\nexport enum Channels {\n  // Grey = 1,\n  // GreyAlpha = 2,\n  RGB = 3,\n  RGBAlpha = 4,\n}\n\nexport interface IImage {\n  data: Data;\n  // No need for width*height, data.length does the job\n  // width:number;\n  // height:number;\n  channels: Channels;\n}\n\nexport type Samples = Uint32Array;\n\nexport function extract(img: IImage, top: number = 12): any[] {\n  const samples: Samples = sample(img);\n  const used: number[][] = pickUsed(samples, samples.length / 4);\n  sortUsed(used);\n  // TODO: Random idea: group similar by HSL (or HUSL?) distance\n  return getColorStats(samples, used, top);\n}\n\nexport function sample(img: IImage): Samples {\n  const topBits = 2;\n\n  /* tslint:disable:no-bitwise */\n  const sides = 1 << topBits;  // 4\n  /* tslint:enable:no-bitwise */\n\n  const shiftM = 2\n  const shiftH = 4\n  const shiftL = 6\n\n  const mask: number = 0b11000000\n  const cubes: number = Math.pow(sides, 3);\n\n  // 4 is RGB + Count\n  const samples: Samples = new Uint32Array(cubes * 4);\n\n  for (let i: number = 0; i < img.data.length; i += img.channels) {\n    const h: number[] = hsl(img.data[i], img.data[i + 1], img.data[i + 2]);\n\n    /* tslint:disable:no-bitwise */\n    let v: number =\n      ((~~(img.data[i] * 0.2126 + img.data[i + 1] * 0.7152 + img.data[i + 2] * 0.0722) & mask) >> shiftM) +\n      ((h[0] & mask) >> shiftH) +\n      ((h[2] & mask) >> shiftL)\n    /* tslint:enable:no-bitwise */\n\n    // 4 is RGB + Count\n    v *= 4;\n\n    samples[v++] += img.data[i];\n    samples[v++] += img.data[i + 1];\n    samples[v++] += img.data[i + 2];\n    samples[v]++;\n  }\n\n  return samples;\n}\n\nexport function hsl(r: number, g: number, b: number): number[] {\n  const max: number = Math.max(r, g, b);\n  const min: number = Math.min(r, g, b);\n\n  /* tslint:disable:no-bitwise */\n  let h: number = 0;\n  let s: number;\n  const l: number = (max + min) >> 1;\n  /* tslint:enable:no-bitwise */\n\n  if (max === min) {\n    s = 0;\n  } else {\n    const d: number = max - min;\n    s = l > 127 ? d / (510 - max - min) : d / (max + min);\n\n    switch (max) {\n      case r:\n        h = (g - b) / d + (g < b ? 6 : 0);\n        break;\n      case g:\n        h = (b - r) / d + 2;\n        break;\n      case b:\n        h = (r - g) / d + 4;\n        break;\n      default:\n        break;\n    }\n\n    h /= 6;\n  }\n\n  return [h * 255, s * 255, l];\n}\n\n/**\n * TODO: sorted only by H\n */\nexport function sortByHsl(stats: any[][]): any[][] {\n  let i: number;\n\n  for (i = 0; i < stats.length; i++) {\n    stats[i][4] = hsl(stats[i][0], stats[i][1], stats[i][2]);\n  }\n\n  stats.sort((a: number[][], b: number[][]): number => {\n    return b[4][0] - a[4][0];\n  });\n\n  for (i = 0; i < stats.length; i++) {\n    delete stats[i][4];\n  }\n\n  return stats;\n}\n\nfunction pickUsed(samples: Samples, cubes: number): number[][] {\n  const used: number[][] = [];\n\n  for (let j: number = 0; j < cubes; j++) {\n    const p: number = j * 4;\n    const s: number = samples[p + 3];\n\n    if (s) {\n      used.push([s, p]);\n    }\n  }\n\n  return used;\n}\n\nfunction sortUsed(used: number[][]): void {\n  used.sort((a: number[], b: number[]): number => {\n    return b[0] - a[0];\n  });\n}\n\nfunction getColorStats(samples: Samples, used: number[][], top: number): any[] {\n  let pixels: number = 0;\n  const stats: any[] = [];\n  const max: number = Math.min(top, used.length);\n  let i: number;\n\n  for (i = 0; i < max; i++) {\n    const count: number = used[i][0];\n    const p: number = used[i][1];\n\n    /* tslint:disable:no-bitwise */\n    const c: number[] = [~~(samples[p] / count), ~~(samples[p + 1] / count), ~~(samples[p + 2] / count), count];\n    /* tslint:enable:no-bitwise */\n\n    stats.push(c);\n    pixels += count;\n  }\n\n  for (i = 0; i < stats.length; i++) {\n    stats[i][3] /= pixels;\n  }\n\n  return stats;\n}\n","import { Channels } from \"./colorgram\";\n\nexport function getPixels(stats: any[],\n                          width: number,\n                          proportional: boolean = false,\n                          channels: Channels = Channels.RGBAlpha): number[] {\n  let step: number;\n  let k: number;\n  let i: number;\n  let current: number;\n  let end: number;\n  let sum: number = 0;\n  const data: number[] = [];\n\n  for (i = 0; i < stats.length; i++) {\n    step = proportional ? stats[i][3] : 1 / stats.length;\n    current = Math.round(width * sum) * 4;\n    end = Math.round(width * (sum + step)) * 4;\n    sum += step;\n    k = current;\n\n    while (current < end) {\n      data[k++] = stats[i][0];\n      data[k++] = stats[i][1];\n      data[k++] = stats[i][2];\n\n      if (channels === Channels.RGBAlpha) {\n        data[k++] = 255;\n      }\n\n      current += channels;\n    }\n  }\n\n  return data;\n}\n"],"names":[],"mappings":"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"}